.PHONY: all clear
.DEFAULT_GOAL := all

# BUILD_DIR_ROOT from top level make
BUILD_DIR := $(BUILD_DIR_ROOT)/liberisa

all: $(BUILD_DIR)/liberisa.so

# Source files
SRC := encoding.c execution.c disasm.c vm.c

# Generated source files
GEN_SRC := isa.h

# Add the src/ prefix
SRC := $(addprefix src/, $(SRC))
GEN_SRC := $(addprefix src/, $(GEN_SRC))

# Generate object and dependency files from source files
OBJ := $(patsubst src/%.c,$(BUILD_DIR)/%.o, $(SRC))
DEP := $(patsubst src/%.c,$(BUILD_DIR)/%.d, $(SRC))

include $(DEP)

# Each dependency file is generated from the source file
$(BUILD_DIR)/%.d: src/%.c $(GEN_SRC)
	@echo -e "[DEP] $(subst $(BUILD_DIR)/,,$@)"
	@$(CC) $(CFLAGS) -MM -MT $(patsubst src/%.c,$(BUILD_DIR)/%.o, $<) $< > $@

$(BUILD_DIR)/%.o: src/%.c
	@echo -e "[CC] $(subst $(BUILD_DIR)/,,$@)"
	@$(CC) $(CFLAGS) -c $< -o $@

$(BUILD_DIR)/liberisa.so: $(OBJ)
	@echo -e "[LD] $(subst $(BUILD_DIR)/,,$@)"
	@$(CC) -shared $(CFLAGS) $^ -o $@

# Autogenerated files
$(GEN_SRC): codegen.py
	@echo -e "[GEN] $@"
	@python -c 'from codegen import *; targets["$@"]()'

src/isa.h: src/isa.h.in data/isa.yaml

clear:
	@echo -e "[RM] $(GEN_SRC) __pycache__"
	@rm $(GEN_SRC) __pycache__ -rf
